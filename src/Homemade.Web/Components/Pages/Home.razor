@page "/"
@using System.Text
@using System.Text.Json
@using Grpc.Core
@using Homemade.Search.Grpc
@inject RecipeSearch.RecipeSearchClient SearchClient

<PageTitle>Home</PageTitle>

<p>Currently available mockups:</p>
<ul>
    <li>
        <NavLink href="/Search">Search</NavLink>
    </li>
    <li>
        <NavLink href="/MealPlanner">Mean Planner</NavLink>
    </li>
    <li>
        <NavLink href="/Recipes">Recipe overview</NavLink>
    </li>
    <li>
        <NavLink href="/Recipes/1">Recipe detail</NavLink>
    </li>
</ul>

<NavLink href="/keycloak">Sign in</NavLink>

<br />

<InputText @bind-Value="Query" />
<button @onclick="OnClick">call</button>
<p>Reply count: @_replies.Count</p>
<ul>
    @foreach (var reply in _replies)
    {
        <li>
            <pre>@Encoding.UTF8.GetString(JsonSerializer.SerializeToUtf8Bytes(reply))</pre>
        </li>
    }
</ul>

@if (_exception != null)
{
    <p>@_exception.Message</p>
    <p>@_exception.StackTrace</p>
}

@code {
    private Exception? _exception;
    private string Query { get; set; } = string.Empty;
    private List<SearchResult> _replies = [];

    public async Task OnClick()
    {
        try
        {
            _replies = await SearchClient.Search(new()
                {
                    SearchText = Query
                })
                .ResponseStream
                .ReadAllAsync()
                .ToListAsync();
        }
        catch (Exception exception)
        {
            _exception = exception;
        }
    }

}